<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Papierwerk Sundern Preisrechner</title>
  <style>
    :root{
      --blue:#0b5ea8;
      --bg:#f5f7fa;
      --card:#ffffff;
      --border:#dfe6ee;
      --muted:#6b7684;
      --good:#dff3e1;
      --bad:#f8d7da;
      --warn:#fff3cd;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;color:#1f2937}
    .wrap{max-width:1400px;margin:22px auto;padding:0 16px}
    h1{margin:0 0 12px;color:var(--blue);font-size:32px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.05);padding:16px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px;align-items:start}
    @media (max-width: 1000px){.grid{grid-template-columns:1fr}}
    label{font-weight:600;font-size:13px;color:#2b3643}
    input{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px}
    input[readonly]{background:#eef4ff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
    @media (max-width: 700px){.row{grid-template-columns:1fr}}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    button{background:var(--blue);color:#fff;border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:#fff;color:#1f2937;border:1px solid var(--border);font-weight:600}
    button:hover{filter:brightness(.97)}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
    .msg{border-radius:10px;padding:10px 12px;margin-top:10px;border:1px solid transparent}
    .msg.warn{background:var(--warn);border-color:#ffe69c}
    .msg.bad{background:var(--bad);border-color:#f1aeb5}
    .msg.good{background:var(--good);border-color:#b6e2bb}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:10px;border:1px solid var(--border);margin-top:14px;background:#fff}
    thead th{background:var(--blue);color:#fff;padding:10px 10px;font-size:13px;text-align:left}
    tbody td{padding:10px 10px;border-top:1px solid var(--border);font-size:14px}
    tbody tr:nth-child(even){background:#f8fbff}
    tbody tr.best{background:var(--good)!important}
    .right{text-align:right}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2f7;color:#344255;font-size:12px;margin-left:8px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .split{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .kv{display:flex;gap:10px;flex-wrap:wrap}
    .kv div{font-size:13px;color:#243141}
    .kv b{color:#111827}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Papierwerk Sundern Preisrechner</h1>

    <div class="card">
      <div class="grid">
        <div>
          <div class="row">
            <div>
              <label for="plz">PLZ (Empfänger)</label>
              <input id="plz" inputmode="numeric" placeholder="z. B. 04525" maxlength="5" />
            </div>
            <div>
              <label for="paletten">Paletten</label>
              <input id="paletten" inputmode="numeric" type="number" min="0" step="1" placeholder="z. B. 6" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="lm">Lademeter (LM)</label>
              <input id="lm" inputmode="decimal" placeholder="auto aus Paletten" />
              <div class="note">Standard: 1 Palette = <b>0,4 LM</b>. Du kannst abweichend auch z. B. <b>0,5</b> setzen oder LM direkt überschreiben.</div>
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="actions">
                <button id="btnCalc">Berechnen</button>
                <button class="secondary" id="btnReset">Zurücksetzen</button>
                <span class="note" id="lmHint">LM wird aus Paletten berechnet (0,4 LM/Palette)</span>
              </div>
            </div>
          </div>

          <div id="status" class="msg warn" style="display:none"></div>

          <div id="summary" class="msg good" style="display:none">
            <div class="kv" id="summaryKv"></div>
          </div>
        </div>

        <div>
          <div id="dataInfo" class="msg warn" style="display:none"></div>
          <div class="note small">
            Dateien werden relativ geladen: <b>zones.csv</b>, <b>rates.csv</b>, <b>floater.json</b>.
          </div>
        </div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Spediteur</th>
          <th>Zone</th>
          <th class="right">Basis (€)</th>
          <th class="right">Floater (%)</th>
          <th class="right">Floater (€)</th>
          <th class="right">Preis (€)</th>
          <th>Grund</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" class="muted">Noch keine Berechnung.</td></tr>
      </tbody>
    </table>
  </div>

<script>
/** ----------------------------
 *  Konfiguration / Helpers
 *  ---------------------------- */
const DEFAULT_LM_PER_PAL = 0.4;
const MAX_LM = 15;

const $ = (id) => document.getElementById(id);
const plzEl = $("plz");
const palEl = $("paletten");
const lmEl  = $("lm");
const tbody = $("tbody");
const statusBox = $("status");
const summaryBox = $("summary");
const summaryKv = $("summaryKv");
const dataInfo = $("dataInfo");
const lmHint = $("lmHint");

function showBox(el, cls, html){
  el.className = "msg " + cls;
  el.innerHTML = html;
  el.style.display = "block";
}
function hideBox(el){ el.style.display="none"; el.innerHTML=""; }

function money(n){
  if(!Number.isFinite(n)) return "—";
  return n.toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2});
}
function parseNumberDE(v){
  if(v==null) return NaN;
  const s = String(v).replace(/\u00A0/g,' ').trim(); // nbsp
  if(!s) return NaN;
  // strip currency and spaces
  const cleaned = s.replace(/€/g,'').replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}
function normHeader(s){
  return String(s||"")
    .replace(/^\uFEFF/,'') // BOM
    .replace(/\u00A0/g,' ')
    .trim()
    .toLowerCase();
}
function parseCsv(text){
  // delimiter guess: prefer ';'
  const sample = text.split(/\r?\n/).slice(0,5).join("\n");
  const semis = (sample.match(/;/g)||[]).length;
  const commas = (sample.match(/,/g)||[]).length;
  const delim = semis >= commas ? ";" : ",";

  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(ch === '"'){
      if(inQ && text[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(!inQ && ch === delim){
      row.push(cur); cur="";
    } else if(!inQ && (ch === "\n" || ch === "\r")){
      if(ch === "\r" && text[i+1] === "\n") i++;
      row.push(cur); cur="";
      // ignore fully empty trailing lines
      if(row.some(c => String(c).trim() !== "")) rows.push(row);
      row = [];
    } else {
      cur += ch;
    }
  }
  row.push(cur);
  if(row.some(c => String(c).trim() !== "")) rows.push(row);
  return {rows, delim};
}

/** ----------------------------
 *  Datenmodelle
 *  ---------------------------- */
let ZONES = [];   // {forwarder, from, to, zone}
let RATES = [];   // {forwarder, from, to, unit, pricesByZone: { [zoneNumber]: price }}
let FLOATERS = {}; // { forwarder: pct }

function unique(arr){ return Array.from(new Set(arr)); }

/** ----------------------------
 *  Loader
 *  ---------------------------- */
async function fetchText(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`${url}: HTTP ${r.status}`);
  return await r.text();
}
async function fetchJson(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`${url}: HTTP ${r.status}`);
  return await r.json();
}

function findHeaderRow(rows, required){
  for(let i=0;i<Math.min(rows.length, 20); i++){
    const h = rows[i].map(normHeader);
    const ok = required.every(k => h.includes(k));
    if(ok) return {i, h};
  }
  return null;
}

async function loadZones(){
  const text = await fetchText("zones.csv");
  const {rows} = parseCsv(text);

  // zones.csv can have a first "Key;;;;" row → find the real header row
  const found = findHeaderRow(rows, ["forwarder","dest from","dest to","zone"]);
  if(!found) throw new Error("zones.csv: Header nicht gefunden (Forwarder / Dest From / Dest To / Zone).");

  const idxF = found.h.indexOf("forwarder");
  const idxA = found.h.indexOf("dest from");
  const idxB = found.h.indexOf("dest to");
  const idxZ = found.h.indexOf("zone");

  const out = [];
  for(let r=found.i+1; r<rows.length; r++){
    const row = rows[r];
    const f = (row[idxF]||"").trim();
    if(!f) continue;
    const a = parseInt(String(row[idxA]||"").trim(),10);
    const b = parseInt(String(row[idxB]||"").trim(),10);
    const z = parseInt(String(row[idxZ]||"").trim(),10);
    if(!Number.isFinite(a) || !Number.isFinite(b) || !Number.isFinite(z)) continue;
    out.push({forwarder:f, from:a, to:b, zone:z});
  }
  ZONES = out;
}

async function loadRates(){
  const text = await fetchText("rates.csv");
  const {rows} = parseCsv(text);

  // Find header row: Forwarder + CHG from + CHG to + Unit + at least Zone 1 column
  let headerIdx = -1;
  let header = null;
  for(let i=0;i<Math.min(rows.length, 30); i++){
    const h = rows[i].map(normHeader);
    if(h.includes("forwarder") && (h.includes("chg from") || h.includes("charge from") || h.includes("from")) &&
       (h.includes("chg to") || h.includes("charge to") || h.includes("to")) &&
       h.includes("unit") && h.some(x => /^zone\s*\d+$/.test(x))){
      headerIdx = i; header = h; break;
    }
  }
  if(headerIdx < 0) throw new Error("rates.csv: Header nicht gefunden (Forwarder / CHG from / CHG to / Unit / Zone n).");

  const idxF = header.indexOf("forwarder");
  const idxFrom = header.indexOf("chg from") >= 0 ? header.indexOf("chg from") : (header.indexOf("charge from") >= 0 ? header.indexOf("charge from") : header.indexOf("from"));
  const idxTo = header.indexOf("chg to") >= 0 ? header.indexOf("chg to") : (header.indexOf("charge to") >= 0 ? header.indexOf("charge to") : header.indexOf("to"));
  const idxUnit = header.indexOf("unit");

  const zoneCols = [];
  header.forEach((h, idx) => {
    const m = h.match(/^zone\s*(\d+)$/);
    if(m) zoneCols.push({zone: parseInt(m[1],10), idx});
  });

  const out = [];
  for(let r=headerIdx+1; r<rows.length; r++){
    const row = rows[r];
    const f = (row[idxF]||"").trim();
    if(!f) continue;
    const unit = (row[idxUnit]||"").trim();
    const from = parseNumberDE(row[idxFrom]);
    const to   = parseNumberDE(row[idxTo]);

    const prices = {};
    for(const zc of zoneCols){
      const p = parseNumberDE(row[zc.idx]);
      if(Number.isFinite(p)) prices[zc.zone] = p;
    }
    out.push({forwarder:f, from, to, unit, pricesByZone: prices});
  }
  RATES = out;
}

async function loadFloaters(){
  try{
    FLOATERS = await fetchJson("floater.json");
  }catch(e){
    // if file missing → default empty, but show warning
    FLOATERS = {};
    showBox(dataInfo, "warn", `Hinweis: <b>floater.json</b> konnte nicht geladen werden. Floater wird als 0% angenommen.<br><span class="small">${e.message}</span>`);
  }
}

/** ----------------------------
 *  Berechnung
 *  ---------------------------- */
function plzValid(s){
  return /^\d{5}$/.test(String(s||"").trim());
}

function computeLm(){
  const pal = Number(palEl.value);
  const lmStr = String(lmEl.value||"").trim();

  if(lmStr === "" || lmStr.toLowerCase().includes("auto")){
    const lm = (Number.isFinite(pal) ? pal : 0) * DEFAULT_LM_PER_PAL;
    lmHint.textContent = `LM wird aus Paletten berechnet (${DEFAULT_LM_PER_PAL.toLocaleString("de-DE")} LM/Palette)`;
    return {lm, mode:"auto"};
  }else{
    const lm = parseNumberDE(lmStr);
    lmHint.textContent = "LM manuell überschrieben";
    return {lm, mode:"manual"};
  }
}

function findZoneFor(plz, forwarder){
  // zones ranges are numeric "dest from/to" (0..99999)
  const p = Number(plz);
  const z = ZONES.find(r => r.forwarder === forwarder && p >= r.from && p <= r.to);
  return z ? z.zone : null;
}

function unitIsLM(unit){
  const u = String(unit||"").toLowerCase();
  return u.includes("lm") || u.includes("lademeter") || u.includes("ldm");
}

function findBasePrice(forwarder, zone, lm){
  const rows = RATES
    .filter(r => r.forwarder === forwarder && unitIsLM(r.unit))
    .filter(r => Number.isFinite(r.from) && Number.isFinite(r.to))
    .filter(r => lm >= r.from && lm <= r.to);

  if(rows.length === 0) return {base:null, reason:"Kein Tarif für LM-Bereich"};

  // choose the tightest match (smallest 'to')
  rows.sort((a,b) => (a.to - b.to) || (a.from - b.from));
  const r = rows[0];
  const base = r.pricesByZone?.[zone];
  if(!Number.isFinite(base)) return {base:null, reason:`Kein Preis für Zone ${zone}`};
  return {base, reason:null};
}

function renderTable(results){
  tbody.innerHTML = "";
  if(results.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" class="muted">Keine Ergebnisse.</td>`;
    tbody.appendChild(tr);
    return;
  }

  // highlight cheapest
  let bestIdx = -1;
  let bestPrice = Infinity;
  results.forEach((r,i)=>{
    if(Number.isFinite(r.price) && r.price < bestPrice){
      bestPrice = r.price;
      bestIdx = i;
    }
  });

  results.forEach((r,i)=>{
    const tr = document.createElement("tr");
    if(i===bestIdx) tr.classList.add("best");
    tr.innerHTML = `
      <td>${r.forwarder}</td>
      <td>${r.zone ?? "—"}</td>
      <td class="right">${Number.isFinite(r.base) ? money(r.base) : "—"}</td>
      <td class="right">${Number.isFinite(r.floaterPct) ? (r.floaterPct.toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2})+"%") : "—"}</td>
      <td class="right">${Number.isFinite(r.floaterEur) ? money(r.floaterEur) : "—"}</td>
      <td class="right">${Number.isFinite(r.price) ? money(r.price) : "—"}</td>
      <td>${r.reason ? `<span class="muted">${r.reason}</span>` : ""}</td>
    `;
    tbody.appendChild(tr);
  });

  return (bestIdx >= 0) ? results[bestIdx] : null;
}

async function ensureLoaded(){
  hideBox(statusBox);
  hideBox(summaryBox);
  hideBox(dataInfo);

  await Promise.all([loadZones(), loadRates(), loadFloaters()]);

  const forwarders = unique([
    ...ZONES.map(z=>z.forwarder),
    ...RATES.map(r=>r.forwarder),
    ...Object.keys(FLOATERS)
  ]).sort((a,b)=>a.localeCompare(b,"de"));

  showBox(dataInfo, "warn", `Daten geladen: <b>${forwarders.length}</b> Spediteure aus <b>zones.csv</b> / <b>rates.csv</b>. Floater aus <b>floater.json</b>.`);
  return forwarders;
}

async function calculate(){
  try{
    const forwarders = await ensureLoaded();

    const plz = String(plzEl.value||"").trim();
    if(!plzValid(plz)){
      showBox(statusBox, "bad", "PLZ muss genau <b>5-stellig</b> sein.");
      tbody.innerHTML = `<tr><td colspan="7" class="muted">Bitte gültige PLZ eingeben.</td></tr>`;
      return;
    }

    const pal = Number(palEl.value);
    if(!Number.isFinite(pal) || pal < 0){
      showBox(statusBox, "bad", "Paletten muss eine gültige Zahl (≥ 0) sein.");
      return;
    }

    const {lm, mode} = computeLm();
    if(!Number.isFinite(lm) || lm <= 0){
      showBox(statusBox, "bad", "Lademeter (LM) muss > 0 sein.");
      return;
    }
    if(lm > MAX_LM){
      showBox(statusBox, "bad", `Lademeter (LM) darf maximal <b>${MAX_LM}</b> sein.`);
      return;
    }

    const results = forwarders.map(f => {
      const zone = findZoneFor(plz, f);
      if(zone == null) return {forwarder:f, zone:null, base:null, floaterPct: FLOATERS[f] ?? 0, floaterEur:null, price:null, reason:"Keine Zone für PLZ"};

      const {base, reason} = findBasePrice(f, zone, lm);
      if(!Number.isFinite(base)) return {forwarder:f, zone, base:null, floaterPct: FLOATERS[f] ?? 0, floaterEur:null, price:null, reason: reason || "Kein Tarif"};

      const floaterPct = Number(FLOATERS[f] ?? 0);
      const floaterEur = base * (floaterPct/100);
      const price = base + floaterEur;

      return {forwarder:f, zone, base, floaterPct, floaterEur, price, reason:null};
    });

    const best = renderTable(results);

    // Summary field (same box; not at top)
    const lmPal = DEFAULT_LM_PER_PAL;
    const bestText = best && Number.isFinite(best.price)
      ? `Günstigster Anbieter: <b>${best.forwarder}</b> (${money(best.price)} €)`
      : `Günstigster Anbieter: —`;

    summaryKv.innerHTML = `
      <div><b>PLZ:</b> ${plz}</div>
      <div><b>Paletten:</b> ${pal}</div>
      <div><b>Lademeter:</b> ${lm.toLocaleString("de-DE",{maximumFractionDigits:2})} <span class="pill">${mode==="auto"?"auto":"manuell"}</span></div>
      <div><b>LM/Palette:</b> ${lmPal.toLocaleString("de-DE",{maximumFractionDigits:2})}</div>
      <div style="flex-basis:100%;margin-top:6px">${bestText}</div>
    `;
    summaryBox.style.display="block";

  }catch(e){
    showBox(statusBox, "bad", `Fehler: ${e.message}`);
    console.error(e);
  }
}

function resetAll(){
  plzEl.value="";
  palEl.value="";
  lmEl.value="";
  hideBox(statusBox);
  hideBox(summaryBox);
  tbody.innerHTML = `<tr><td colspan="7" class="muted">Noch keine Berechnung.</td></tr>`;
}

function onPalettenChange(){
  const {lm, mode} = computeLm();
  if(mode==="auto"){
    lmEl.value = (Number.isFinite(lm) ? lm.toLocaleString("de-DE",{maximumFractionDigits:2}) : "");
  }
}
palEl.addEventListener("input", () => {
  // only auto-update if lm not manually set
  const lmStr = String(lmEl.value||"").trim();
  if(lmStr==="" || lmStr.toLowerCase().includes("auto")) onPalettenChange();
  else {
    // if user typed manual LM, do not override
    lmHint.textContent = "LM manuell überschrieben";
  }
});

$("btnCalc").addEventListener("click", calculate);
$("btnReset").addEventListener("click", resetAll);

// Initialize: make LM auto placeholder
lmEl.value = "";
lmEl.placeholder = "auto aus Paletten";
</script>
</body>
</html>
